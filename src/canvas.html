<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Cube</title>
    <link rel="stylesheet" href="styles/canvas.css">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <div id="canvas-container">
        <h1>The Cube</h1>
        <div class="controls">
            <button id="drawLine">Draw Line</button>
            <button id="drawRect">Draw Rectangle</button>
            <button id="drawCircle">Draw Circle</button>
            <button id="drawTheCube">Draw the Cube</button>
            <button id="clearCanvas">x Clear Canvas</button>
        </div>
        <div id="app-version" style="position: absolute; top: 10px; right: 10px; font-size: 14px; background-color: rgba(255,255,255,0.8); padding: 5px 10px; border-radius: 3px; border: 1px solid #ccc;">Loading version...</div>
        <canvas id="drawingCanvas" width="800" height="600"></canvas>
        <div id="instructions" style="position: absolute; bottom: 10px; left: 10px; color: #333; font-family: Arial, sans-serif; font-size: 14px;"></div>
        <div id="version" style="position: absolute; bottom: 30px; left: 10px; color: #333; font-family: Arial, sans-serif; font-size: 14px;"></div>
    </div>


    <!-- Initialize canvas context first -->
    <script>
        // Make canvas and context globally available
        window.initCanvas = function() {
            const canvas = document.getElementById('drawingCanvas');
            if (!canvas) {
                console.error('Canvas element not found');
                return false;
            }

            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('Could not get 2D context');
                return false;
            }

            // Set default styles
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#000000';
            ctx.fillStyle = '#3498db';

            // Make them globally available
            window.canvas = canvas;
            window.ctx = ctx;

            console.log('Canvas context initialized');
            return true;
        };

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            window.initCanvas();
            console.log('Canvas initialized in DOMContentLoaded');

            // Verify global variables
            setTimeout(() => {
                console.log('Checking globals:',
                    'canvas:', window.canvas ? 'OK' : 'MISSING',
                    'ctx:', window.ctx ? 'OK' : 'MISSING');
            }, 500);
        });

        // Dynamic script loading with cache busting
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const timestamp = new Date().getTime();
                const script = document.createElement('script');
                script.type = 'module';
                script.src = src + '?v=' + timestamp;
                script.onload = () => {
                    console.log('Script loaded:', src);
                    resolve();
                };
                script.onerror = () => {
                    console.error('Failed to load script:', src);
                    reject();
                };
                document.body.appendChild(script);
            });
        }

        // Wait for DOM to be loaded before adding scripts
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Loading scripts...');
            // Load scripts in sequence to ensure proper initialization order
            loadScript('../dist/version.js')
                .then(() => loadScript('../dist/models/objects/2d/line.js'))
                .then(() => loadScript('../dist/models/objects/2d/rectangle.js'))
                .then(() => loadScript('../dist/models/objects/2d/circle.js'))
                .then(() => loadScript('../dist/clear.js'))
                .then(() => loadScript('../dist/models/objects/3d/cube.js'))
                .then(() => {
                    console.log('All scripts loaded successfully');

                    // Display version using the version module
                    if (window.appVersion && typeof window.appVersion.toString === 'function') {
                        console.log(`Running version: ${window.appVersion.toString()}`);

                        // Update version element directly1
                        const versionElement = document.getElementById('app-version');
                        if (versionElement) {
                            versionElement.textContent = `Version: ${window.appVersion.toString()}`;
                        }
                    } else {
                        console.warn('Version module not loaded properly');
                        // Fallback version display
                        const versionElement = document.getElementById('app-version');
                        if (versionElement) {
                            const now = new Date();
                            const buildDate = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
                            versionElement.textContent = `Version: v1.0.0+${buildDate}`;
                        }
                    }

                    // Re-initialize event listeners to ensure they're attached after script loading
                    setTimeout(() => {
                        console.log('Re-initializing event listeners');
                        // Force re-initialization of event handlers if modules export init functions
                        if (window.initCubeDrawing) {
                            window.initCubeDrawing();
                        }
                        if (window.initLineDrawing) {
                            window.initLineDrawing();
                        }
                        if (window.initRectangleDrawing) {
                            window.initRectangleDrawing();
                        }
                        if (window.initCircleDrawing) {
                            window.initCircleDrawing();
                        }
                        if (window.initClearCanvas) {
                            window.initClearCanvas();
                        }
                    }, 100);
                })
                .catch(error => {
                    console.error('Error loading scripts:', error);
                });
        });
    </script>
</body>
</html>