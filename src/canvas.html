<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Cube</title>
    <link rel="stylesheet" href="styles/canvas.css">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <div id="canvas-container">
        <h1>The Cube</h1>
        <div class="controls">
            <button id="drawLine">Draw Line</button>
            <button id="drawRect">Draw Rectangle</button>
            <button id="drawCircle">Draw Circle</button>
            <button id="drawTheCube">Draw the Cube</button>
            <button id="clearCanvas">x Clear Canvas</button>
        </div>
        <div id="app-version" style="position: absolute; top: 10px; right: 10px; font-size: 14px; background-color: rgba(255,255,255,0.8); padding: 5px 10px; border-radius: 3px; border: 1px solid #ccc;">Loading version...</div>
        <canvas id="drawingCanvas" width="800" height="600"></canvas>
        <div id="instructions" style="position: absolute; bottom: 10px; left: 10px; color: #333; font-family: Arial, sans-serif; font-size: 14px;"></div>
        <div id="version" style="position: absolute; bottom: 30px; left: 10px; color: #333; font-family: Arial, sans-serif; font-size: 14px;"></div>
    </div>


    <!-- Initialize canvas context first -->
    <script>
        let canvas;
        let ctx;
        function loadScript(url) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                // Add cache-busting query parameter
                script.src = url + '?v=' + new Date().getTime();
                script.type = 'module'; // Add type="module" for ES modules
                script.onload = () => resolve();
                script.onerror = () => reject(new Error(`Script load error for ${url}`));
                document.head.appendChild(script);
            });
        }

        function initCanvas() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            
            // Make canvas and context available globally
            window.canvas = canvas;
            window.ctx = ctx;
            console.log('Canvas initialized and exposed globally');
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Load version module first
            loadScript('../dist/version.js')
                .then(() => {
                    // Start loading 2D modules
                    return loadScript('../dist/models/objects/2d/line.js');
                })
                .then(() => loadScript('../dist/models/objects/2d/rectangle.js'))
                .then(() => loadScript('../dist/models/objects/2d/circle.js'))
                .then(() => loadScript('../dist/clear.js'))
                // Load 3D modules in dependency order
                .then(() => loadScript('../dist/models/objects/3d/world-space.js'))
                .then(() => loadScript('../dist/models/objects/3d/camera-eye.js'))
                .then(() => loadScript('../dist/models/objects/3d/screen-space.js'))
                .then(() => loadScript('../dist/models/objects/3d/figure-3d.js'))
                .then(() => loadScript('../dist/models/objects/3d/cube.js'))
                .then(() => loadScript('../dist/models/objects/3d/world-3d.js'))
                .then(() => loadScript('../dist/controllers/cube-controller.js'))
                .then(() => {
                    console.log('All scripts loaded successfully');

                    // Initialize canvas
                    initCanvas();

                    // Initialize cube drawing
                    if (window.initCubeDrawing) {
                        window.initCubeDrawing();
                    } else {
                        console.error('initCubeDrawing function not found');
                    }

                    // Display version using the version module
                    if (window.appVersion && typeof window.appVersion.toString === 'function') {
                        console.log(`Running version: ${window.appVersion.toString()}`);

                        // Update version element directly
                        const versionElement = document.getElementById('app-version');
                        if (versionElement) {
                            versionElement.textContent = `Version: ${window.appVersion.toString()}`;
                        }
                    } else {
                        console.warn('Version module not loaded properly');
                        // Fallback version display
                        const versionElement = document.getElementById('app-version');
                        if (versionElement) {
                            const now = new Date();
                            const buildDate = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
                            versionElement.textContent = `Version: v1.0.0+${buildDate}`;
                        }
                    }

                    // Re-initialize event listeners to ensure they're attached after script loading
                    setTimeout(() => {
                        console.log('Re-initializing event listeners');
                        // Force re-initialization of event handlers if modules export init functions
                        if (window.initLineDrawing) {
                            window.initLineDrawing();
                        }
                        if (window.initRectangleDrawing) {
                            window.initRectangleDrawing();
                        }
                        if (window.initCircleDrawing) {
                            window.initCircleDrawing();
                        }
                        if (window.initClearCanvas) {
                            window.initClearCanvas();
                        }
                    }, 100);
                })
                .catch(error => {
                    console.error('Error loading scripts:', error);
                });
        });
    </script>
</body>
</html>